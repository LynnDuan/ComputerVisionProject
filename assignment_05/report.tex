% !TeX spellcheck = en_US
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Lachaise Assignment
% LaTeX Template
% Version 1.0 (26/6/2018)
%
% This template originates from:
% http://www.LaTeXTemplates.com
%
% Authors:
% Marion Lachaise & François Févotte
% Vel (vel@LaTeXTemplates.com)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass{article}
\usepackage{bm}

\input{structure.tex} % Include the file specifying the document structure and custom commands

%----------------------------------------------------------------------------------------
%	ASSIGNMENT INFORMATION
%----------------------------------------------------------------------------------------

\title{CMPT726: Assignment \#1} % Title of the assignment

\author{Lin Duan 301369502 \& Jingwen Zhang 301368992 \\ \texttt{duanlind@sfu.ca \& jingwen\_zhang\_2sfu.ca }} % Author name and email address

\date{Simon Fraser University--- \today} % University, school and/or department name(s) and a date

%----------------------------------------------------------------------------------------

\begin{document}
	
	\maketitle % Print the title
	
	%----------------------------------------------------------------------------------------
	%	INTRODUCTION
	%----------------------------------------------------------------------------------------
	
	\section{Implementation} 
	\subsection{checkinliner} 
	For the point $x_{1*3}$ in the previous images , and the relevant point $x_{1*3}^{'}$ in the next image,  if $x^{T} F x^{'} \leq  d$, then return true.
	\subsection{Findfundmental}
	Firstly, normalized the previous subset and the next subset. Then use the normalized subsets to form a matrix $A$, which $$A = \begin{pmatrix}
	x_{1}^{'}x_{1} & x_{1}^{'}y_{1} & x_{1}^{'} & y_{1}^{'}x_{1} & y_{1}^{'}y_{1} & y_{1}^{'} & x_1 & y_1 & 1 \\
	\vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots  \\
	x_{8}^{'}x_{8} & x_{8}^{'}y_{8} & x_{8}^{'} & y_{8}^{'}x_{8} & y_{8}^{'}y_{8} & y_{8}^{'} & x_8 & y_8 & 1
	\end{pmatrix}$$
	And then use SVD to decompose the $A$ to get the last column of $V$, and resize it into 3*3 matrix. Then use SVD to decompose this matrix to get $U_1, W_1, V_{1}^{T}$and set the $W_1(3,3)$ into 0.0. Then compute the fundamental matrix with $F= U_1 W_1 V_{1}^{T}$. And de-normalize the fundamental matrix with $F = N^{T}FN$
	
	\subsection{Findessential}
	$E = K^{T} F K$
	\subsection{relativepose}
	This function is supposed to get four relative pose between two frames. Firstly, use SVD to decompose the essential matrix $E$ to get $U, W, V^{T}$, and set $W_{tmp}$ with $W_{tmp}(0,1) = -1, W_{tmp}(1,0) = 1, W_{tmp}(2,2) = 1$. 
	
	Secondly, we could get two candidate rotation matrix with $R_1 = UW_{tmp}V^T$ and $R_1 = UW_{tmp}^{T}V^T$. And check their determinant, if $|R| < 0$ then $R = -R$. And the candidate transition matrix$T_1$ and $T_2$ should be the last column of $U$ and its negative one. 
	
	Finally, the candidate relative pose should be $[R_1, T_1]$ or $[R_2, T_1]$ or $[R_1, T_2]$ or $[R_2, T_2]$
	\subsection{triangulation}
	This function is supposed to get the correct relative pose between two frames. First, we set $(x,y)$ is point from the previous subset, $(x^{'},y^{'})$ is point from the next subset, and $P$ is projection matrix for the first camera, and $P^{'}$ is projection matrix for the second camera which we compute in the previous part. 
	
	Then, we set $$A = \begin{pmatrix}
	yp_{3}^{T} - p_{2}^{T} \\
	p_{1}^{T} - xp_{3}^{T} \\
	y^{'}p_{3}^{'T} - p_{2}^{'T} \\
	p_{1}^{'T} - x^{'}p_{3}^{'T}
	\end{pmatrix}$$
	Then, use SVD to decompose $A$ and we could get $V^{T}$. And the location in 3D place should be the last column of $V$, which should be $X = (x,y,z,1)$ , and for each previous key points we get a $z$, for each next key points we get a $z^{'}$. For each candidate camera pose, we count the number when $z$ and $z^{'}$ are both positive.  Then the right relative should be the one with largest number. 
	

\section{Result}

\subsection{Essential Matrix}
Firstly, we compute the fundamental matrix, and we check the fundamental matrix with opencv's function 'findFundamentalMat'. We set the normalized matrix to be $\begin{pmatrix}
\frac{2}{h} & 0 & -1 \\
0 & \frac{2}{w} & -1 \\
0 & 0 & 1
\end{pmatrix}$

And we draw the epipolar constraint as below:

\begin{figure}[h]
	\centering
	\includegraphics[width=3.5in]{wrong.jpg}
	\caption{Nornalized-01}
\end{figure}

It seems their not quite the same. Then we change the normalization matrix into:$\begin{pmatrix}
\frac{3}{h} & 0 & -1.1 \\
0 & \frac{3}{w} & -1.1 \\
0 & 0 & 1
\end{pmatrix}$

Then we get:
\begin{figure}[h]
	\centering
	\includegraphics[width=3.5in]{correct.jpg}
	\caption{Nornalized-02}
\end{figure}

\begin{figure}[h]
	\centering
	\includegraphics[width=3.5in]{example.jpg}
	\caption{another example}
\end{figure}

I think the opencv's function doesn't use the same normalization as ours. And when we use different normalized matrix, the epipolar constraint becomes different. 

And then we check the fundamental matrix, after we correct the normalization we get:

Ours = 

$\begin{pmatrix}
-3.659150193881673e-07 & 0.0005045466575220245& 0.001278904965744987\\
-0.0005111755357057115 & 4.214772098631035e-08& 0.2299619944249809\\
-0.003350739034679 & -0.2297454482774965 &0.9999999999999999
\end{pmatrix}$ 

Opencv's = 

$\begin{pmatrix}
-3.770218424900359e-07& 0.0004595618639777839& -0.004903897467006754\\
-0.0004660854871973241&-3.327412881753011e-07& 0.2375100374095139\\
0.003193487642428392& -0.2369338437376147& 1
\end{pmatrix}$ 

They look quite similar to each other.

And essential should be $E = K^{T}FK = $

\subsection{Relative Pose}
The relative pose should be as below:

We check the correctness with 'test five points'. 
And the rotation matrix we get is:

$\begin{pmatrix}
0.9999561864028342& -0.001081652661562135& -0.009298134340809422\\
0.001019461911297808& 0.9999770976290041& -0.006690658778073656 \\
0.009305158360362123&0.006680886542438612& 0.9999343877389635
\end{pmatrix}$ 

The correct one should be $\begin{pmatrix}
1& 0& 0\\
0& 1& 0\\
0&0& 1
\end{pmatrix}$

And the transition matrix we get is 

$[0.04262558990908046;
0.03707821835812766;
0.9984028569712178]$. 

And the correct one should be $[0;0;1]$

They are almost the same.

\subsection{Triangulated 3d map points}
Suppose the triangulated 3d map points is $X$, then $x = PX$, $X = P^{-1}x$. $P$ should be the correct relative pose between two frames.
And we set some examples here.


	
\end{document}